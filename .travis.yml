sudo: required
language: python
services:
  - docker
env:
  global:
    # DOCKER_USER
    - secure: jCj8yde6O5zcsXqIy+wMKPcMjIN3YKXPMuXjsNIn4Gvnx6n10c4lsgdOLfKoH7KO0dqsiLG05/h0bDnDV+YIMDG7Imwa4laTDOLYtU+JJl2J5oPznTQdCGdKFz7e0tAPjfGptpUiU0UqreNFe+rbrP2Xeb63NZtWlMBQ8Vh5mYNYCVc0JePljSaxK+Uyfg+yjPNItiGHYlr0UD78iN2t3oVzBje6VfPoZs65to6ogemmHbBughGAkomTCeki4imPJKh8pGJo03mmA0j0P4KNu9BVsxHv7kQDL3NtfMHbJkAIJYiPXFfEfnKtkdhHTWONjj1jLJnElio46sGFgGkUDS9zMcaQ4S4mD6pLjSHMXV1t6l3+5Fm+OJZpXJeKZUK+PI8I78fYdpKglayzFiwTYYvaG4zGLvqo1lR7XCZYwoi64EN/HVRDhXmSfe7E0I1yFjwSW6vTIhLC4QCEMreyTmvpWzH6vY+69uPV3oxgYlGD8O7t6oghF4JRU7q5FroHEclRJ9wfbVQQTgQhliFQLXBZjzVaqaYGuTTa2ZTWeqfLxF3jW37CHNBW4aNbc7JHwTYT/qT3osJN8Rq58GXydUb5H3VV7pUBR5UvhTxEGHuGpEmYVenjiYtsue8e35T3ylis/NnVNyTFI36k/R5pEoXD2k3XTOdE/fqiM4eamtE=
    # DOCKER_PASS
    - secure: gRLLOKBhbaUGKtjn9ZcTZGSJR4Fql++I9RIfMMuoJsLqpoDEVrvJwU34nVoux0drfWSdNICPDu1XmxQP/M9mWpHr/sJNwpJN/d+PwI1wLQIagra+2BkfYxxqcEJ7HbYoeMay5hBzIZwMwUqeMHjZfkuQ2vC9NmJsDPBoMPVDaHXtiqidsTHeDaDeVyYiFzjb5PHb10vIYBQDngGzKUeHHV6pxpTHIPmDzlibYEzVcQFgMnaQ4vxuCh6FO/EUjXF0OhRfYHI/0esaPkr0ZwLzLffAubt4glDoJCDeqVNRdmMq/NO8Sxg328+4+KCLhEE5/5zeXaDJrb8jMwJaSLT53KiEm63YjcVyozdhIqfDHh4vuUNQHMl6DCsfa4xKrUp4SS4Gl9Akg5V6+MweCbf7bQNxeMWuhChg93bOfVvT7BGPgVZ6lbz5iyYaqU02bP4+6xnUPvFwCjuF+oPv11FqCX9s34/EASMnul11JeYaQ8kwrAYdiK47z9Q2Ve447AgEdO03O4TMQAMY6D+/spRCYvdy3oOwAtszZAzKHsxB3yg+7PQM+WRzkXJ0SuhZGbeCyeG2m3LYQNIrwOj4CuTfupCGPJbfH4nrrbzFbg9cAwV3WGlBANm1GS/wUyRU1+Nnk+WBpFrY2LmAUmjedvdwHx3cONbKeQcaXo7EJWIRsKg=
    # IMAGE_REPO
    - secure: ELhN67w744U/8uNIIrXmvRCsaA57Upx6/n874U45IaY3ki/XGApwXfwB4y+x2in5Z9ytuMd0ItNdCZWATycJPKOygHdi1d6ktqOBAiTGPX9jbM3ZlQDF3GwjAyOLQyequQroflwfxJzav6/NrbLVb6q6EBVh5tmSAGGWvzEfF8GRQYVYQLubmq76ftooOGYh6LWWb2Ut8L7Q3m7e6ebUrnkvcrqNOc2Nel7D+C99HHNX/o/3GV7/3cxq/wMey/8M0fpDqEBvI+K1F0YjMBFPq2P2svdAcqoqowVBPzA7duOgI60gmAb8KclayeD7QDxrWa4YhSetyUs/BmmB9/hDSuRoKLcf0bXCtSg7vhoi6PeapC72Ml+vknQFoZrRLsl5xScFCuweMaaEMXUb0w6Rx72C0UBGJttvnwfY4QQ2xEihFBFKVEc3eC3CJH6pYqll4Jbr8qt2ijcDdFmYBWkQK1Cnz2EjQDUARgckwk19MfqxfFNObctHmolB3QK1Jna+U+iYaM/yMdtii3R5UXW/OyzDZc/JPqiPSTuNagvVIqqXE3PTrMqUV0hu7zQMLS8shXqIIA7cy6IXeDLLaE0gs5z1c/AJhfa+EUqmhmquCph0R9+YhazWGC9rhI5BE1GryoRidA2y/oyR4nLUoc8Vt3yqLqgS7bgRoEzrHpuI3NM=
    # IMAGE_VERSION 
    - secure: YxnHI2NaeYMwj+rAL17OKHqR8bEdTFFMtNd97mdb4ZPzxiCDNP05VOJte2vv+QDwlaubBiu0MF+le+JorhgIFtBKB9BzWh4rNKtwDaSne/IcZ8afhFqhdBAbKroocto1k1auewQgcpWRi9N7rtBRgzhP91UnoeZWYFdsuLbLgZWk6qPo26WU2HM4CZbkFOzA9JSyWGc11kfiGwDFg+UMC7XWPIvmmQmV/T9wWfHKkWZSh/YEXrdVNd5RQ8xb3hgrnIBhwlg03bHF+DgiDuDsXSSlLMxAjmh+7uZ9kDqL3XttGRG7BW35PSJpYH/wfZD6PQqPVHPUrWWfgp+7zhQddWLF80UwILOF8/PwmJgUNSzKQ7si0KecDuvo65h0RmEyKdB4M2mh8Gv8KyQWF0Ly0qQFfF5d+68ATTbj3d181913xo/DUyVrYu20x79+psAimYIkT891Zbqd1AmIaixReC1imFan1GohPUdfxn3YUWrRVyWFvolJWJ/pS0GhSMMec544grACZHiECcDQTbThm6+SPSonSzl3RppDJdhCKvjoAWx31uZO3wrgBC2LKb0/zbdpUzrhf44dZzzmO2DtatSh7YjnNEUgv5E1c7Szn0XKv5lso8j1FKEfFQgEUA093va7EToopiLIH7sfosrKcwld/CWTBimKs4nNNlLW7XU=
  
script:
  - docker-compose build
  - sudo TEST_VIA=False docker-compose -f docker-compose.yml -f docker-compose.test.yml up --exit-code-from test

after_success:
  - docker login -u $DOCKER_USER -p $DOCKER_PASS
  - export TAG=`if [[ $TRAVIS_PULL_REQUEST == "false" ]] && [[ $TRAVIS_BRANCH == "master" ]]; then echo "latest"; else echo $IMAGE_VERSION; fi`
  - docker tag $IMAGE_REPO $IMAGE_REPO:$TAG
  - docker push $IMAGE_REPO:$TAG
